---
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/sections/Header.astro";
import Footer from "../components/sections/Footer.astro";
import Button from "../components/ui/button/Button.astro";
import MediaGallery from "../components/media/MediaGallery.astro";
import FormattedDate from "../components/FormattedDate.astro";

type Props = CollectionEntry<"portfolio">["data"];

const {
    title,
    description,
    pubDate,
    heroImage,
    techStack,
    ctaLink,
    ctaText,
    company,
    whereToPlay,
    screenshots,
    trailer,
} = Astro.props;

// Helper to get YouTube embed URL
function getEmbedUrl(url: string) {
    const regExp =
        /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return match && match[2].length === 11
        ? `https://www.youtube.com/embed/${match[2]}`
        : url;
}
---

<html lang="en" data-theme="light" class="light">
    <head>
        <BaseHead title={title} description={description} />
        <style>
            /* Custom styles if needed, but using Tailwind mostly */
            .sidebar-title {
                font-size: 1.125rem; /* text-lg */
                font-weight: 700;
                margin-bottom: 0.5rem;
                display: block;
            }
        </style>
    </head>

    <body
        class="overflow-x-hidden portfolio-background"
        data-hero-image={heroImage?.src}
    >
        <style
            define:vars={{
                heroImageUrl: heroImage ? `url(${heroImage.src})` : "none",
            }}
        >
            body.portfolio-background::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-image: var(--heroImageUrl);
                background-size: cover;
                background-position: center top;
                filter: blur(10px);
                opacity: 0.5;
                z-index: 0;
                mask-image: radial-gradient(
                    ellipse 60% 70% at center 15%,
                    black 0%,
                    black 30%,
                    transparent 90%
                );
                -webkit-mask-image: radial-gradient(
                    ellipse 60% 70% at center 15%,
                    black 0%,
                    black 30%,
                    transparent 90%
                );
                pointer-events: none;
            }

            body.portfolio-background::after {
                content: "";
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100vh;
                background: linear-gradient(
                    to bottom,
                    transparent,
                    transparent 30%,
                    var(--color-bg)
                );
                z-index: 0;
                pointer-events: none;
            }

            body.portfolio-background > * {
                position: relative;
                z-index: 1;
            }
        </style>
        <Header />
        <main class="min-h-screen relative">
            <article
                class="relative z-10 max-w-[1400px] mx-auto px-4 pt-4 pb-4 md:pt-8 md:pb-8 md:px-8"
            >
                {/* Hero Image */}
                {/* Media Gallery (Trailer + Screenshots) */}
                <div class="w-full mb-8">
                    <MediaGallery screenshots={screenshots} trailer={trailer} />
                </div>

                {/* Title Section - Centered and Highlighted */}
                <div class="w-full mb-12 text-center">
                    <h1
                        class="text-4xl md:text-5xl lg:text-6xl font-bold mb-4 text-[var(--color-text-primary)] leading-tight"
                        style="text-shadow: 0 0 40px rgba(var(--accent-rgb), 0.3), 0 0 80px rgba(var(--accent-rgb), 0.2);"
                    >
                        {title}
                    </h1>
                    <p
                        class="text-xl text-[var(--color-text-secondary)] opacity-90 max-w-6xl mx-auto"
                    >
                        {description}
                    </p>
                </div>

                <div
                    class="grid grid-cols-1 lg:grid-cols-[300px_1fr] gap-6 md:gap-12"
                >
                    {/* Sidebar Information */}
                    <aside class="space-y-8 h-fit lg:sticky lg:top-24">
                        {
                            company && (
                                <div>
                                    <span class="sidebar-title text-[var(--color-text-primary)]">
                                        Company
                                    </span>
                                    <p class="text-[var(--color-text-secondary)]">
                                        {company}
                                    </p>
                                </div>
                            )
                        }
                        <div>
                            <span
                                class="sidebar-title text-[var(--color-text-primary)]"
                            >
                                Publish Date
                            </span>
                            <div class="text-[var(--color-text-secondary)]">
                                <FormattedDate date={pubDate} />
                            </div>
                        </div>

                        {
                            whereToPlay && whereToPlay.length > 0 && (
                                <div>
                                    <span class="sidebar-title text-[var(--color-text-primary)]">
                                        Where to play
                                    </span>
                                    <div class="flex flex-col gap-2 items-start">
                                        {whereToPlay.map((item) => (
                                            <a
                                                href={item.url}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                class="text-[var(--color-text-secondary)] hover:text-[var(--accent)] underline decoration-1 underline-offset-4 transition-colors uppercase text-sm tracking-wide font-medium"
                                            >
                                                {item.platform}
                                            </a>
                                        ))}
                                    </div>
                                </div>
                            )
                        }

                        {
                            techStack && techStack.length > 0 && (
                                <div>
                                    <span class="sidebar-title text-[var(--color-text-primary)]">
                                        Technologies
                                    </span>
                                    <ul class="list-none space-y-2 p-0 m-0">
                                        {techStack.map((tech) => (
                                            <li class="text-[var(--color-text-primary)] opacity-80 text-sm">
                                                {tech}
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            )
                        }

                        {
                            ctaLink && (
                                <div class="pt-4">
                                    <Button
                                        href={ctaLink}
                                        variant="primary"
                                        size="lg"
                                        className="w-full justify-center"
                                    >
                                        {ctaText || "Visit Project"}
                                    </Button>
                                </div>
                            )
                        }
                    </aside>

                    {/* Main Content */}
                    <div
                        class="prose prose-lg dark:prose-invert max-w-none text-[var(--color-text-secondary)]"
                    >
                        <slot />
                    </div>
                </div>
            </article>
        </main>
        <Footer />
    </body>
</html>
