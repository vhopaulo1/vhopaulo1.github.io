---
import { SITE_TITLE } from "../../consts";
import HeaderLink from "./HeaderLink.astro";
import ThemeToggle from "../ui/button/ThemeToggle.astro";
import { getLangFromUrl, useTranslations } from "../../i18n/utils";
import { languages } from "../../i18n/ui";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

function getLink(path: string) {
  return lang === "en" ? path : `/${lang}${path}`;
}

const currentPath = Astro.url.pathname;
const otherLang = lang === "en" ? "pt-br" : "en";
const otherLangLabel = languages[otherLang];

// Calculate target link for language switcher
let targetLink = "/";
if (lang === "en") {
    // English -> Portuguese: Add /pt-br prefix
    targetLink = `/pt-br${currentPath === "/" ? "" : currentPath}`;
} else {
    // Portuguese -> English: Remove /pt-br prefix
    // Ensure we handle /pt-br/ properly
    const pathWithoutLang = currentPath.replace(`/${lang}`, "") || "/";
    targetLink = pathWithoutLang;
}
---

<header
    class="bg-[var(--color-bg-primary)] text-foreground border-b sw-header relative z-20"
>
    <nav
        class="mx-auto max-w-6xl px-4 py-2 flex items-center justify-between relative"
    >
        <div class="flex items-center gap-3">
            <a
                class="no-underline hover:opacity-90 flex items-center gap-2"
                href={getLink("/")}
                aria-label="Home"
            >
                <img
                    src="/favicon.svg?v=1"
                    alt=""
                    aria-hidden="true"
                    width="45"
                    height="45"
                />
            </a>
        </div>

        <div
            class="internal-links hidden md:flex items-center gap-2 absolute left-1/2 -translate-x-1/2"
        >
            <HeaderLink
                href={getLink("/")}
                class="px-2 py-3 text-[color:var(--color-text-secondary)] no-underline"
                >{t('nav.home')}</HeaderLink
            >
            <HeaderLink
                href={getLink("/portfolio")}
                class="px-2 py-3 text-[color:var(--color-text-secondary)] no-underline"
                >{t('nav.portfolio')}</HeaderLink
            >
            <HeaderLink
                href={getLink("/about")}
                class="px-2 py-3 text-[color:var(--color-text-secondary)] no-underline"
                >{t('nav.about')}</HeaderLink
            >
            <HeaderLink
                href={getLink("/blog")}
                class="px-2 py-3 text-[color:var(--color-text-secondary)] no-underline"
                >{t('nav.blog')}</HeaderLink
            >
            <a
                href="https://www.linkedin.com/in/pgameartist/"
                class="px-2 py-3 text-[color:var(--color-text-secondary)] no-underline"
                target="_blank"
                rel="noopener noreferrer">Contact</a
            >
        </div>

        <div class="flex items-center gap-3">
            <div class="social-links hidden md:flex items-center gap-3">
                <a href={targetLink} class="text-sm font-medium hover:text-[color:var(--accent)] uppercase">
                    {otherLang}
                </a>
            </div>
            <ThemeToggle />
            <button
                type="button"
                aria-label="Open menu"
                aria-controls="mobile-menu"
                aria-expanded="false"
                data-menu-btn
                class="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-lg text-[color:var(--color-text-secondary)] hover:text-white"
            >
                <svg
                    viewBox="0 0 24 24"
                    width="24"
                    height="24"
                    aria-hidden="true"
                    ><path
                        fill="currentColor"
                        d="M3 6h18v2H3V6Zm0 5h18v2H3v-2Zm0 5h18v2H3v-2Z"
                    ></path></svg
                >
            </button>
        </div>
    </nav>
    <div id="mobile-menu" class="md:hidden hidden border-t">
        <div class="mx-auto max-w-6xl px-4 py-3 flex flex-col gap-2">
            <div class="flex flex-col">
                <HeaderLink href={getLink("/")} class="px-2 py-3">{t('nav.home')}</HeaderLink>
                <HeaderLink href={getLink("/portfolio")} class="px-2 py-3"
                    >{t('nav.portfolio')}</HeaderLink
                >
                <HeaderLink href={getLink("/about")} class="px-2 py-3">{t('nav.about')}</HeaderLink>
                <HeaderLink href={getLink("/blog")} class="px-2 py-3">{t('nav.blog')}</HeaderLink>
                <a
                    href="https://www.linkedin.com/in/pgameartist/"
                    class="px-2 py-3"
                    target="_blank"
                    rel="noopener noreferrer"
                    >Contact
                </a>
                <a href={targetLink} class="px-2 py-3 font-medium uppercase text-[color:var(--accent)]">
                    {otherLangLabel}
                </a>
            </div>
            <div class="flex items-center gap-4 pt-2">
                <!--
                    <a href="https://github.com/guihubie/free-astro-template" target="_blank" class="group text-[color:var(--color-text-secondary)]">
                        <span class="sr-only">Go to GitHub</span>
                        <svg viewBox="0 0 16 16" aria-hidden="true" width="24" height="24" class="transition-colors group-hover:text-[color:var(--accent)]"><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
                    </a>
                
                <svg
                    viewBox="0 0 16 16"
                    aria-hidden="true"
                    width="22"
                    height="22"
                    class="transition-colors group-hover:text-white"
                    ><path
                        fill="currentColor"
                        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"
                    ></path></svg
                -->
            </div>
        </div>
    </div>
</header>

<script is:inline>
    const btn = document.querySelector("[data-menu-btn]");
    const panel = document.getElementById("mobile-menu");
    function toggleMenu() {
        if (!panel || !btn) return;
        const isOpen = !panel.classList.contains("hidden");
        if (isOpen) {
            panel.classList.add("hidden");
            btn.setAttribute("aria-expanded", "false");
        } else {
            panel.classList.remove("hidden");
            btn.setAttribute("aria-expanded", "true");
        }
    }
    btn?.addEventListener("click", toggleMenu);
    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
            if (!panel?.classList.contains("hidden")) toggleMenu();
        }
    });
    document.addEventListener("click", (e) => {
        if (!panel || !btn) return;
        const target = e.target;
        const clickedInside = panel.contains(target) || btn.contains(target);
        if (!clickedInside && !panel.classList.contains("hidden")) toggleMenu();
    });
</script>
