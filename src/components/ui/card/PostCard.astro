---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import FormattedDate from '../../FormattedDate.astro';
import { calculateReadingTimeFromMarkdown } from '../../../lib/reading';
import { slugifyTag as slugify } from '../../../lib/slug';

import { author } from '../../../data/author';

interface Props { 
  post: CollectionEntry<'blog'>;
  lang?: 'en' | 'pt-br';
}
const { post, lang = 'en' } = Astro.props as Props;
// Estimate reading time from raw body (Markdown/MDX)
let readingTimeMin = 0;
try {
  // @ts-ignore - body may not exist until rendered; fallback to data.description
  const md = (post as any).body ?? '';
  readingTimeMin = calculateReadingTimeFromMarkdown(md || post.data.description || '');
} catch {}

const slug = post.id.replace(new RegExp(`^${lang}/`), '');
const rootPath = lang === 'en' ? '/blog' : `/${lang}/blog`;
---

<article class="card-surface p-4 grid grid-cols-1 md:grid-cols-[1fr_2fr] gap-5 md:gap-6 items-stretch relative">
  {post.data.heroImage && (
    <div class="md:col-span-1 relative overflow-hidden rounded-lg">
        <Image class="w-full h-full object-cover rounded-lg" width={640} height={360} src={post.data.heroImage} alt={post.data.title} />
    </div>
  )}
  <div class="md:col-span-1 flex flex-col justify-between space-y-2">
    <div>
        <h3 class="text-2xl font-bold text-[color:var(--color-text-primary)] mb-2">{post.data.title}</h3>
        <p class="text-[color:var(--color-text-secondary)] line-clamp-3">{post.data.description}</p>
    </div>
    
    <div class="space-y-3">
        <div class="flex items-center gap-3 text-sm text-[color:var(--color-text-muted)] mt-2">
            <FormattedDate date={post.data.pubDate} locale={lang} />
            <span>•</span>
            <a href={`${rootPath}/author/${slugify(post.data.author || author.name)}/`} class="hover:text-[color:var(--accent)] interactive-link relative z-10">{post.data.author || author.name}</a>
            {readingTimeMin > 0 && (
            <>
                <span>•</span>
                <span class="flex items-center gap-1">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="12" cy="12" r="9"/>
                    <path d="M12 7v5l3 3"/>
                </svg>
                {readingTimeMin} min read
                </span>
            </>
            )}
        </div>

        {post.data.tags && post.data.tags.length > 0 && (
            <div class="flex gap-2 flex-wrap">
            {post.data.tags.map((t) => <a href={`${rootPath}/tag/${t.replace(/\s+/g,'-').toLowerCase()}/`} class="sw-tag interactive-link relative z-10">{t}</a>)}
            </div>
        )}
    </div>
  </div>
  <a href={`${rootPath}/${slug}/`} class="stretched-link" aria-label={post.data.title}></a>
</article>


